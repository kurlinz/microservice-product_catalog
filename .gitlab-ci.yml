stages:
  - build
  - push

variables:
  # Docker-in-Docker settings
  DOCKER_TLS_CERTDIR: ""
  DOCKER_REGISTRY: "docker.io"
  IMAGE_NAME: "product-catalog"

build_image:
  stage: build
  image: docker:24.0.2
  services:
    - name: docker:dind
      alias: docker
  variables:
    IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker save $IMAGE_NAME:$IMAGE_TAG -o image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1h

push_image:
  stage: push
  image: docker:24.0.2
  services:
    - name: docker:dind
      alias: docker
  variables:
    IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  only:
    - main
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
  script:
    - docker load -i image.tar
    - docker tag $IMAGE_NAME:$IMAGE_TAG $DOCKER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG $DOCKER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:latest
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:latest
  environment:
    name: production

# Notes:
# - Set CI variables in GitLab: DOCKER_REGISTRY (optional, default docker.io), DOCKER_USERNAME, DOCKER_PASSWORD.
# - Optionally override IMAGE_NAME and IMAGE_TAG.
# - Push runs only for the `main` branch; adjust `only` as needed.
